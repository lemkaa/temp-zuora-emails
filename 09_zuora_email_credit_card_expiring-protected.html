<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>Password Protected Page</title>
    <style>
        html, body {
            margin: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, Helvetica, sans-serif;
        }
        #dialogText {
            color: white;
            background-color: #333333;
        }
        
        #dialogWrap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: table;
            background-color: #EEEEEE;
        }
        
        #dialogWrapCell {
            display: table-cell;
            text-align: center;
            vertical-align: middle;
        }
        
        #mainDialog {
            max-width: 400px;
            margin: 5px;
            border: solid #AAAAAA 1px;
            border-radius: 10px;
            box-shadow: 3px 3px 5px 3px #AAAAAA;
            margin-left: auto;
            margin-right: auto;
            background-color: #FFFFFF;
            overflow: hidden;
            text-align: left;
        }
        #mainDialog > * {
            padding: 10px 30px;
        }
        #passArea {
            padding: 20px 30px;
            background-color: white;
        }
        #passArea > * {
            margin: 5px auto;
        }
        #pass {
            width: 100%;
            height: 40px;
            font-size: 30px;
        }
        
        #messageWrapper {
            float: left;
            vertical-align: middle;
            line-height: 30px;
        }
        
        .notifyText {
            display: none;
        }
        
        #invalidPass {
            color: red;
        }
        
        #success {
            color: green;
        }
        
        #submitPass {
            font-size: 20px;
            border-radius: 5px;
            background-color: #E7E7E7;
            border: solid gray 1px;
            float: right;
            cursor: pointer;
        }
        #contentFrame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #attribution {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 0.8em;
        }
        #attribution, #attribution a {
            color: #999;
        }
        .error {
            display: none;
            color: red;
        }
    </style>
  </head>
  <body>
    <iframe id="contentFrame" frameBorder="0" allowfullscreen></iframe>
    <div id="dialogWrap">
        <div id="dialogWrapCell">
            <div id="mainDialog">
                <div id="dialogText">This page is password protected.</div>
                <div id="passArea">
                    <p id="passwordPrompt">Password</p>
                    <input id="pass" type="password" name="pass" autofocus>
                    <div>
                        <span id="messageWrapper">
                            <span id="invalidPass" class="error">Sorry, please try again.</span>
                            <span id="trycatcherror" class="error">Sorry, something went wrong.</span>
                            <span id="success" class="notifyText">Success!</span>
                            &nbsp;
                        </span>
                        <button id="submitPass" type="button">Submit</button>
                        <div style="clear: both;"></div>
                    </div>
                </div>
                <div id="securecontext" class="error">
                    <p>
                        Sorry, but password protection only works over a secure connection. Please load this page via HTTPS.
                    </p>
                </div>
                <div id="nocrypto" class="error">
                    <p>
                        Your web browser appears to be outdated. Please visit this page using a modern browser.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div id="attribution">
        Protected by <a href="https://www.maxlaumeister.com/pagecrypt/">PageCrypt</a>
    </div>
    <script>
    (function() {

        var pl = "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";
        
        var submitPass = document.getElementById('submitPass');
        var passEl = document.getElementById('pass');
        var invalidPassEl = document.getElementById('invalidPass');
        var trycatcherror = document.getElementById('trycatcherror');
        var successEl = document.getElementById('success');
        var contentFrame = document.getElementById('contentFrame');
        
        // Sanity checks

        if (pl === "") {
            submitPass.disabled = true;
            passEl.disabled = true;
            alert("This page is meant to be used with the encryption tool. It doesn't work standalone.");
            return;
        }

        if (!isSecureContext) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#securecontext").style.display = "block";
            return;
        }

        if (!crypto.subtle) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#nocrypto").style.display = "block";
            return;
        }
        
        function str2ab(str) {
            var ustr = atob(str);
            var buf = new ArrayBuffer(ustr.length);
            var bufView = new Uint8Array(buf);
            for (var i=0, strLen=ustr.length; i < strLen; i++) {
                bufView[i] = ustr.charCodeAt(i);
            }
            return bufView;
        }

        async function deriveKey(salt, password) {
            const encoder = new TextEncoder()
            const baseKey = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey'],
            )
            return await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
                baseKey,
                { name: 'AES-GCM', length: 256 },
                true,
                ['decrypt'],
            )
        }
        
        async function doSubmit(evt) {
            submitPass.disabled = true;
            passEl.disabled = true;

            let iv, ciphertext, key;
            
            try {
                var unencodedPl = str2ab(pl);

                const salt = unencodedPl.slice(0, 32)
                iv = unencodedPl.slice(32, 32 + 16)
                ciphertext = unencodedPl.slice(32 + 16)

                key = await deriveKey(salt, passEl.value);
            } catch (e) {
                trycatcherror.style.display = "inline";
                console.error(e);
                return;
            }

            try {
                const decryptedArray = new Uint8Array(
                    await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext)
                );

                let decrypted = new TextDecoder().decode(decryptedArray);

                if (decrypted === "") throw "No data returned";

                const basestr = '<base href="." target="_top">';
                const anchorfixstr = `
                    <script>
                        Array.from(document.links).forEach((anchor) => {
                            const href = anchor.getAttribute("href");
                            if (href.startsWith("#")) {
                                anchor.addEventListener("click", function(e) {
                                    e.preventDefault();
                                    const targetId = this.getAttribute("href").substring(1);
                                    const targetEl = document.getElementById(targetId);
                                    targetEl.scrollIntoView();
                                });
                            }
                        });
                    <\/script>
                `;
                
                // Set default iframe link targets to _top so all links break out of the iframe
                if (decrypted.includes("<head>")) decrypted = decrypted.replace("<head>", "<head>" + basestr);
                else if (decrypted.includes("<!DOCTYPE html>")) decrypted = decrypted.replace("<!DOCTYPE html>", "<!DOCTYPE html>" + basestr);
                else decrypted = basestr + decrypted;

                // Fix fragment links
                if (decrypted.includes("</body>")) decrypted = decrypted.replace("</body>", anchorfixstr + '</body>');
                else if (decrypted.includes("</html>")) decrypted = decrypted.replace("</html>", anchorfixstr + '</html>');
                else decrypted = decrypted + anchorfixstr;
                
                contentFrame.srcdoc = decrypted;
                
                successEl.style.display = "inline";
                setTimeout(function() {
                    dialogWrap.style.display = "none";
                }, 1000);
            } catch (e) {
                invalidPassEl.style.display = "inline";
                passEl.value = "";
                submitPass.disabled = false;
                passEl.disabled = false;
                console.error(e);
                return;
            }
        }
        
        submitPass.onclick = doSubmit;
        passEl.onkeypress = function(e){
            if (!e) e = window.event;
            var keyCode = e.keyCode || e.which;
            invalidPassEl.style.display = "none";
            if (keyCode == '13'){
              // Enter pressed
              doSubmit();
              return false;
            }
        }
    })();
    </script>
  </body>
</html>
