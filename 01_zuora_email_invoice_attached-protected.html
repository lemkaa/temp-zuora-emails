<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>Password Protected Page</title>
    <style>
        html, body {
            margin: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, Helvetica, sans-serif;
        }
        #dialogText {
            color: white;
            background-color: #333333;
        }
        
        #dialogWrap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: table;
            background-color: #EEEEEE;
        }
        
        #dialogWrapCell {
            display: table-cell;
            text-align: center;
            vertical-align: middle;
        }
        
        #mainDialog {
            max-width: 400px;
            margin: 5px;
            border: solid #AAAAAA 1px;
            border-radius: 10px;
            box-shadow: 3px 3px 5px 3px #AAAAAA;
            margin-left: auto;
            margin-right: auto;
            background-color: #FFFFFF;
            overflow: hidden;
            text-align: left;
        }
        #mainDialog > * {
            padding: 10px 30px;
        }
        #passArea {
            padding: 20px 30px;
            background-color: white;
        }
        #passArea > * {
            margin: 5px auto;
        }
        #pass {
            width: 100%;
            height: 40px;
            font-size: 30px;
        }
        
        #messageWrapper {
            float: left;
            vertical-align: middle;
            line-height: 30px;
        }
        
        .notifyText {
            display: none;
        }
        
        #invalidPass {
            color: red;
        }
        
        #success {
            color: green;
        }
        
        #submitPass {
            font-size: 20px;
            border-radius: 5px;
            background-color: #E7E7E7;
            border: solid gray 1px;
            float: right;
            cursor: pointer;
        }
        #contentFrame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #attribution {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 0.8em;
        }
        #attribution, #attribution a {
            color: #999;
        }
        .error {
            display: none;
            color: red;
        }
    </style>
  </head>
  <body>
    <iframe id="contentFrame" frameBorder="0" allowfullscreen></iframe>
    <div id="dialogWrap">
        <div id="dialogWrapCell">
            <div id="mainDialog">
                <div id="dialogText">This page is password protected.</div>
                <div id="passArea">
                    <p id="passwordPrompt">Password</p>
                    <input id="pass" type="password" name="pass" autofocus>
                    <div>
                        <span id="messageWrapper">
                            <span id="invalidPass" class="error">Sorry, please try again.</span>
                            <span id="trycatcherror" class="error">Sorry, something went wrong.</span>
                            <span id="success" class="notifyText">Success!</span>
                            &nbsp;
                        </span>
                        <button id="submitPass" type="button">Submit</button>
                        <div style="clear: both;"></div>
                    </div>
                </div>
                <div id="securecontext" class="error">
                    <p>
                        Sorry, but password protection only works over a secure connection. Please load this page via HTTPS.
                    </p>
                </div>
                <div id="nocrypto" class="error">
                    <p>
                        Your web browser appears to be outdated. Please visit this page using a modern browser.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div id="attribution">
        Protected by <a href="https://www.maxlaumeister.com/pagecrypt/">PageCrypt</a>
    </div>
    <script>
    (function() {

        var pl = "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";
        
        var submitPass = document.getElementById('submitPass');
        var passEl = document.getElementById('pass');
        var invalidPassEl = document.getElementById('invalidPass');
        var trycatcherror = document.getElementById('trycatcherror');
        var successEl = document.getElementById('success');
        var contentFrame = document.getElementById('contentFrame');
        
        // Sanity checks

        if (pl === "") {
            submitPass.disabled = true;
            passEl.disabled = true;
            alert("This page is meant to be used with the encryption tool. It doesn't work standalone.");
            return;
        }

        if (!isSecureContext) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#securecontext").style.display = "block";
            return;
        }

        if (!crypto.subtle) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#nocrypto").style.display = "block";
            return;
        }
        
        function str2ab(str) {
            var ustr = atob(str);
            var buf = new ArrayBuffer(ustr.length);
            var bufView = new Uint8Array(buf);
            for (var i=0, strLen=ustr.length; i < strLen; i++) {
                bufView[i] = ustr.charCodeAt(i);
            }
            return bufView;
        }

        async function deriveKey(salt, password) {
            const encoder = new TextEncoder()
            const baseKey = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey'],
            )
            return await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
                baseKey,
                { name: 'AES-GCM', length: 256 },
                true,
                ['decrypt'],
            )
        }
        
        async function doSubmit(evt) {
            submitPass.disabled = true;
            passEl.disabled = true;

            let iv, ciphertext, key;
            
            try {
                var unencodedPl = str2ab(pl);

                const salt = unencodedPl.slice(0, 32)
                iv = unencodedPl.slice(32, 32 + 16)
                ciphertext = unencodedPl.slice(32 + 16)

                key = await deriveKey(salt, passEl.value);
            } catch (e) {
                trycatcherror.style.display = "inline";
                console.error(e);
                return;
            }

            try {
                const decryptedArray = new Uint8Array(
                    await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext)
                );

                let decrypted = new TextDecoder().decode(decryptedArray);

                if (decrypted === "") throw "No data returned";

                const basestr = '<base href="." target="_top">';
                const anchorfixstr = `
                    <script>
                        Array.from(document.links).forEach((anchor) => {
                            const href = anchor.getAttribute("href");
                            if (href.startsWith("#")) {
                                anchor.addEventListener("click", function(e) {
                                    e.preventDefault();
                                    const targetId = this.getAttribute("href").substring(1);
                                    const targetEl = document.getElementById(targetId);
                                    targetEl.scrollIntoView();
                                });
                            }
                        });
                    <\/script>
                `;
                
                // Set default iframe link targets to _top so all links break out of the iframe
                if (decrypted.includes("<head>")) decrypted = decrypted.replace("<head>", "<head>" + basestr);
                else if (decrypted.includes("<!DOCTYPE html>")) decrypted = decrypted.replace("<!DOCTYPE html>", "<!DOCTYPE html>" + basestr);
                else decrypted = basestr + decrypted;

                // Fix fragment links
                if (decrypted.includes("</body>")) decrypted = decrypted.replace("</body>", anchorfixstr + '</body>');
                else if (decrypted.includes("</html>")) decrypted = decrypted.replace("</html>", anchorfixstr + '</html>');
                else decrypted = decrypted + anchorfixstr;
                
                contentFrame.srcdoc = decrypted;
                
                successEl.style.display = "inline";
                setTimeout(function() {
                    dialogWrap.style.display = "none";
                }, 1000);
            } catch (e) {
                invalidPassEl.style.display = "inline";
                passEl.value = "";
                submitPass.disabled = false;
                passEl.disabled = false;
                console.error(e);
                return;
            }
        }
        
        submitPass.onclick = doSubmit;
        passEl.onkeypress = function(e){
            if (!e) e = window.event;
            var keyCode = e.keyCode || e.which;
            invalidPassEl.style.display = "none";
            if (keyCode == '13'){
              // Enter pressed
              doSubmit();
              return false;
            }
        }
    })();
    </script>
  </body>
</html>
